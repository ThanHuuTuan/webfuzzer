<!doctype html>
<html class="no-js" lang="en">
    <?php include("head.php") ?>
    <?php
    if (!isset($_SESSION['token'])){
        header('Location: login.php');
        die();
    }?>
    <?php
        $token = $_SESSION['token'];
        $all = GET('/scans', $token)['body'];
        $allScanID = array();
        for ( $x = 0; $x < count($all); $x++ ) { 
            array_push($allScanID, $all[$x]['id']);
        }
        // var_dump($all);
        // var_dump($allScanID);

    ?>
    <body>
        <div class="main-wrapper">
            <div class="app" id="app">
            	<?php 
            		include("header.php"); 
            		include("sidebar.php");
            	?>		
                <article class="content dashboard-page">
                    <section class="section">
                        <h4>Total vulnerability report</h4><br>
                        <div class="card col-md-12">
                            <div class="card-block">
                                <section class="example">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Severity</th>
                                                    <th>Name</th>
                                                    <th>Number</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php
                                                    for ( $x = 0; $x < count($allScanID); $x++ ) { 
                                                        $vulsInAScan = GET('/vulns/'.$allScanID[$x], $token)['body'];
                                                        // var_dump($allVul);
                                                        for ( $y = 0; $y < count($vulsInAScan); $y++ ) { 
                                                            $vul = $vulsInAScan[$y];
                                                            $severity = $vul['severity'];
                                                            $vulName = $vul['name'];
                                                            $severityColor = '';
                                                            $url = $vul['url'];
                                                            if ($vul['severity'] == 'Information'){
                                                                $severityColor = 'label-info';
                                                            }elseif ($vul['severity'] == 'Low') {
                                                                $severityColor = 'label-success';
                                                            }elseif ($vul['severity'] == 'Medium') {
                                                                $severityColor = 'label-warning';
                                                            }elseif ($vul['severity'] == 'High') {
                                                                $severityColor = 'label-danger';
                                                            }
                                                            echo '<tr onclick="window.document.location=\'./detailVulnerabilityScan.php?scanID='.$allScanID[$x].'&vulID='.$vul['id'].'\';"style="cursor: pointer;">';
                                                            echo '<td><span class="label '.$severityColor.' col-md-8">'.$severity.'</span></td>';
                                                            echo '<td>'.$vulName.' ('.$url.')</td>';
                                                            echo '<td>1</td>';
                                                            echo '</tr>';
                                                        }
                                                    }
                                                ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </section>                    
                </article>
            </div>
        </div>
        <!-- Reference block for JS -->
        <div class="ref" id="ref">
            <div class="color-primary"></div>
            <div class="chart">
                <div class="color-primary"></div>
                <div class="color-secondary"></div>
            </div>
        </div>
        <script src="js/vendor.js"></script>
        <script src="js/app.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script type="text/javascript">
            jQuery(document).ready(function($) {
    $(".clickable-row").click(function() {
        window.document.location = $(this).data("href");
    });
});
        </script>
    </body>

</html>